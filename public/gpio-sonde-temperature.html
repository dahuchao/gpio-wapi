<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/google-chart/google-chart.html">
<dom-module id="gpio-sonde-temperature">
    <style>
        :host {
            display: block;
            position: relative;
            background-color: white;
            padding: 20px;
            width: 100%;
            font-size: 1.2rem;
            font-weight: 300;
        }
        
        google-chart {
            height: 300px;
            width: 70em;
        }
    </style>
    <template>
        <iron-ajax url='gpio/temperatures' method='GET' handle-as='json' last-response='{{temperaturesPassees}}' on-response='receptionTemperatures' auto></iron-ajax>
        <google-chart type='line' options='{"title": "Température"}' cols='[{"label":"date", "type":"string"}, {"label":"mesure", "type":"number"}]' rows='{{donnees}}'>
        </google-chart>
    </template>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        Polymer({
            is: "gpio-sonde-temperature",
            properties: {
                donnees: Array,
                temperaturesPassees: Object
            },
            created: function () {
                console.info('Initialisation.');
                donnees = new Array();
                //this.donnees.push(["init", 0]);
            },
            ready: function () {
                var that = this;
                var hostname = document.location.hostname;
                var port = document.location.port;
                var socket = io.connect('ws://' + hostname + ':' + port);
                // Proposition Aumaury : var socket = io.connect('ws://' + document.location.hostname + ':' + document.location.port);
                socket.on('message', function (message) {
                    console.info('Le serveur a un message pour vous : ' + message);
                });
                socket.on('temperature', function (temperature) {
                    var floatMesure = parseFloat(temperature.valeur);
                    console.info('Nouvelle mesure : ' + floatMesure);
                    donnees.push([temperature.date, floatMesure]);
                    //that.donnees.push(["Mai", mesure]);
                });
            },
            receptionTemperatures: function () {
                console.info('Reception des temperature passées.');
                // Pour chaque mesure de température
                for (var i = 0; i < temperaturesPassees.length; i++) {
                    var temperature = temperaturesPassees[i];
                    var floatMesure = parseFloat(temperature.valeur);
                    this.donnees.push([temperature.date, floatMesure]);
                    console.info('Reception des temperature passées : %s/%s(%s)', temperature.date, temperature.mesure, typeof temperature.mesure);
                }
            }
        });
    </script>
</dom-module>